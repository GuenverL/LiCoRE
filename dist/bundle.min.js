$("#btnExport").click(function(){for(var e='<?xml version = "1.0" encoding="UTF-8" standalone="yes" ?>\n<arbre>\n',n=0,o=competencesValidees.length;o>n;++n){var c=competencesValidees[n];e+="  <competence>\n       <id>"+c.idCompetence+"</id>\n       <nom>"+c.nomCompetence+"</nom>\n       <idPere>"+c.idPereCompetence+"</idPere>\n"}e+="</arbre>",$("#linkXML").click(function(){this.href="data:application/xml;charset=utf-8,"+encodeURIComponent(e)})});
function genererBoutonGestion(e,n,o,t){"use strict";var i="";return i+="setCompetencesVisibles"===n||e.feuille&&"setCompetencesInvisibles"===n?' <span id="competence-'+e.idCompetence+'-button-visibilite" data-toggle="modal"':' <span data-toggle="modal" data-target="#genericModal" data-type="'+n+'" data-id-competence="'+e.idCompetence+'" data-nom-competence="'+e.nomCompetence+'"',i+=' data-placement="top" data-original-title="'+o+'" class="glyphicon cursor-pointer '+t+'" aria-hidden="true"></span>'}function genererLigneCompetenceGestion(e,n){"use strict";var o="";return o+='<li id="competence-'+e.idCompetence+'"',void 0===e.visible||e.visible||(o+=' class="couleur-grise"'),o+="display-none"===n?' style="display: none;">':">",o+='<a href="#">'+e.nomCompetence+"</a>",o+=genererBoutonGestion(e,"ajouterCompetence","Ajouter une compétence","glyphicon-plus couleur-verte"),o+=genererBoutonGestion(e,"ajouterPlusieursCompetences","Ajouter plusieurs compétences","glyphicon-th-list couleur-verte"),o+=genererBoutonGestion(e,"modifierCompetence","Modifier une compétence","glyphicon-pencil couleur-jaune"),o+=e.visible||void 0===e.visible?genererBoutonGestion(e,"setCompetencesInvisibles","Rendre la compétence invisible","glyphicon-eye-close couleur-bleue"):genererBoutonGestion(e,"setCompetencesVisibles","Rendre la compétence visible","glyphicon-eye-open couleur-bleue"),o+=genererBoutonGestion(e,"supprimerCompetence","Supprimer une compétence","glyphicon-remove couleur-rouge")}function genererListeCompetences(e,n,o,t){"use strict";var i="",c=0;n||c||(i+="\n<ul>\n");for(var r=0,s=o.length;s>r;++r){var l=o[r];if(e===l.idPereCompetence){if(n>c&&(i+="\n<ul>\n"),"gestionCompetences"===t){var u={idCompetence:l.idCompetence,nomCompetence:l.nomCompetence,visible:l.visible,feuille:l.feuille};i+=genererLigneCompetenceGestion(u,"display-normal")}else i+='<li id="competence-'+l.idCompetence+'"',i+=l.valide?' class="couleur-text-valide">':' class="couleur-text-lien">',i+='<a href="#">'+l.nomCompetence+"</a>";c=n,i+=genererListeCompetences(l.idCompetence,n+1,o,t)}}return i+=c===n&&0!==c?"</ul>\n</li>\n":c===n?"</ul>\n":"</li>\n"}function majArbre(e){"use strict";$(e).each(function(){$(this).treeview()})}
$("#genericModal").on("show.bs.modal",function(e){"use strict";var t=$("#buttonSubmit");$(this).removeData("modal"),t.off();var o=$(e.relatedTarget),n=o[0].dataset.idCompetence,a=o[0].dataset.nomCompetence,l=o[0].dataset.type,i=$(this),r=function(e){i.find(".modal-body #genericModalForm").empty(),i.find(".modal-title").text(e.title),i.find(".modal-body #genericModalForm").append(e.body),i.find(".modal-body #label").text(e.label),i.find(".modal-body #nomCompetence").val(e.nomCompetence)},c={};switch(l){case"ajouterCompetence":c.title='Ajouter une compétence à "'+a+'"',c.body='<div class="form-group"><label for="nom-competence" class="control-label" id="label"></label><input type="text" class="form-control" id="nomCompetence"></div>',c.label="Nom de la nouvelle compétence :",c.nomCompetence="";break;case"ajouterPlusieursCompetences":c.title='Ajouter des compétences à "'+a+'"',c.body='<div class="form-group"><label for="nom-competence" class="control-label" id="label"></label><textarea rows="20" class="form-control" id="nomCompetence"></textarea></div>',c.label="Nom des nouvelles compétences (séparée par un retour à la ligne) :",c.nomCompetence="";break;case"modifierCompetence":c.title='Modifier la compétence "'+a+'"',c.body='<div class="form-group"><label for="nom-competence" class="control-label" id="label"></label><input type="text" class="form-control" id="nomCompetence"></div>',c.label="Nom :",c.nomCompetence=a;break;case"supprimerCompetence":var s=o.data("feuille");c.label="",c.nomCompetence=a,s?(c.title='Supprimer la compétence "'+a+'"',c.body='<div class="alert alert-danger" role="alert"><strong>Attention!</strong><p>Voulez-vous vraiment continuer et supprimer cette compétence ?</p></div>'):(c.title='Supprimer la catégorie "'+a+'" et ses sous-compétences',c.body='<div class="alert alert-danger" role="alert"><strong>Attention!</strong><p>La suppression de cette catégorie entrainera la suppression de toutes ses sous-catégories et compétences.</p><p>Voulez-vous vraiment continuer et supprimer cette catégorie ?</p></div>');break;case"setCompetencesInvisibles":c.label="",c.nomCompetence=a,c.title='Rendre invisible la catégorie "'+a+'" et ses sous-compétences',c.body='<div class="alert alert-warning" role="alert"><strong>Attention!</strong><p>Rendre invisible cette catégorie va mettre invisible toutes ses sous-catégories et compétences.</p><p>Voulez-vous vraiment continuer et rendre invisible cette catégorie ?</p></div>';break;case"validerCompetence":c.label="",c.nomCompetence=a,c.title='Validation de la compétence "'+a+'"',c.body='<div class="alert alert-warning" role="alert"><strong>Attention!</strong><p>Vous allez valider une compétence et celle ci sera donc mise en attente de validation par un tuteur. Voulez vous continuer ?</p></div>';break;case"invaliderCompetence":c.label="",c.nomCompetence=a,c.title='Invalidation de la compétence "'+a+'"',c.body='<div class="alert alert-warning" role="alert"><strong>Attention!</strong><p>Vous allez invalider une compétence et celle ci sera donc retiré de votre liste de compétences validées. Voulez vous continuer ?</p></div>';break;case"invaliderCompetenceTemporaire":c.label="",c.nomCompetence=a,c.title='Invalidation de la compétence "'+a+'"',c.body='<div class="alert alert-warning" role="alert"><strong>Attention!</strong><p>Vous allez retirer une compétence actuellement en attente de validation par un tuteur. Voulez vous continuer ?</p></div>';break;case"validationCompetenceParTuteur":var m=o[0].dataset.nomUtilisateur;c.label="",c.nomCompetence="",c.title='Valider la compétence "'+a+'" pour "'+m+'"',c.body='<div class="alert alert-warning" role="alert"><strong>Attention!</strong><p>Vous allez valider cette compétence pour '+m+". Voulez vous continuer ?</p></div>";break;case"invalidationCompetencesUtilisateurs":var m=o[0].dataset.nomUtilisateur;c.label="",c.nomCompetence="",c.title='Invalider la compétence "'+a+'" pour "'+m+'"',c.body='<div class="alert alert-warning" role="alert"><strong>Attention!</strong><p>Vous allez invalider cette compétence pour '+m+". Voulez vous continuer ?</p></div>"}r(c);var p={};"validerCompetence"===l||"invaliderCompetence"===l||"invaliderCompetenceTemporaire"===l?(p={idCompetence:n,nomCompetence:a,type:l},t.click(p,buttonSubmitValidation)):"validationCompetenceParTuteur"===l||"invalidationCompetencesUtilisateurs"===l?(p={idCompetence:n,nomCompetence:a,idUtilisateur:o[0].dataset.idUtilisateur,type:l},t.click(p,buttonSubmitValidation)):(p={idCompetence:n,type:l},t.click(p,buttonSubmitGestionCompetences))});
function setCompetencesVisibilite(e,t){"use strict";for(var n=0,o=e.length;o>n;++n){var c=e[n];if("setCompetencesInvisibles"===t){$("#competence-"+c.idCompetence).addClass("couleur-grise"),$("#competence-"+c.idCompetence).find("span.glyphicon-eye-close").remove(),$("#competence-"+c.idCompetence).find("span.glyphicon-eye-open").remove(),$("#competence-"+c.idCompetence).find("span.glyphicon-pencil").after(genererBoutonGestion(c,"setCompetencesVisibles","Rendre la compétence visible","glyphicon-eye-open couleur-bleue"));var i={idCompetence:c.idCompetence,nomCompetence:c.nomCompetence,visibilite:"setCompetencesVisibles"};$("#competence-"+c.idCompetence+"-button-visibilite").off(),$("#competence-"+c.idCompetence+"-button-visibilite").click(i,setCompetencesVisibiliteOnClick)}else $("#competence-"+c.idCompetence).toggleClass("couleur-grise"),$("#competence-"+c.idCompetence).find("span.glyphicon-eye-open").first().remove(),$("#competence-"+c.idCompetence).find("span.glyphicon-pencil").first().after(genererBoutonGestion(c,"setCompetencesInvisibles","Rendre la compétence invisible","glyphicon-eye-close couleur-bleue")),$("#competence-"+c.idCompetence+"-button-visibilite").off()}}function setCompetencesVisibiliteOnClick(e){"use strict";var t=e.data.idCompetence,n=e.data.visibilite;$.getJSON("api/competences.php",{type:n,idCompetence:t}).always(function(e){$(".tooltip").remove(),setCompetencesVisibilite(e,n),$('[data-toggle="modal"]').tooltip()})}function majButtons(e){"use strict";$buttonSelectionne.removeClass("active"),e.addClass("active"),$buttonSelectionne=e}function majArbreGestionCompetences(e,t){"use strict";var n=$(e);typeAffichageCompetences=t,$buttonSelectionne.selector!==n.selector&&(majButtons(n),$("#arbreGestionCompetences").empty(),$("#arbreGestionCompetences").hide(),$("#loader-competences").show(),$.getJSON("api/competences.php",{type:t}).always(function(e){""!==e.responseText&&($("#arbreGestionCompetences").append('<li id="listeCompetences"><a href="#">Liste des compétences</a>'),$("#listeCompetences").append(genererListeCompetences(0,0,e,"gestionCompetences")),majArbre("#arbreGestionCompetences"),$('[data-toggle="modal"]').tooltip(),$("#loader-competences").hide(),$("#arbreGestionCompetences").show())}))}function buttonSubmitGestionCompetences(e){"use strict";var t=e.data.idCompetence,n=e.data.type,o=$("#genericModal").find(".modal-body #nomCompetence").val();$.getJSON("api/competences.php",{type:n,idCompetence:t,nomCompetence:o}).always(function(e){if(e){var c=function(e){var n=$("#competence-"+t).find("ul").length,o=$("#competence-"+t).find("i").hasClass("glyphicon-chevron-down");0===n&&$("#competence-"+t).append("<ul>");for(var c=0,i=e.length;i>c;++c){var s=e[c];-1!==s.idCompetence&&(o?$("#competence-"+t).find("ul").first().append(genererLigneCompetenceGestion(s,"display-normal")):$("#competence-"+t).find("ul").first().append(genererLigneCompetenceGestion(s,"display-none")))}0===n&&($("#competence-"+t).append("</ul>"),actualiserBranche($("#competence-"+t)),$("#competence-"+t).find("i").removeClass("glyphicon-chevron-right"),$("#competence-"+t).find("i").addClass("glyphicon-chevron-down"))};switch(n){case"ajouterCompetence":-1!==e.idCompetence&&c([e]);break;case"ajouterPlusieursCompetences":c(e);break;case"modifierCompetence":e.retour&&($("#competence-"+t).find("span.glyphicon-plus").first().attr("data-nom-competence",o),$("#competence-"+t).find("span.glyphicon-th-list").first().attr("data-nom-competence",o),$("#competence-"+t).find("span.glyphicon-pencil").first().attr("data-nom-competence",o),$("#competence-"+t).find("span.glyphicon-eye-close").first().attr("data-nom-competence",o),$("#competence-"+t).find("span.glyphicon-eye-open").first().attr("data-nom-competence",o),$("#competence-"+t).find("span.glyphicon-remove").first().attr("data-nom-competence",o),$("#competence-"+t).find("a").first().empty(),$("#competence-"+t).find("a").first().append(o));break;case"setCompetencesInvisibles":setCompetencesVisibilite(e,"setCompetencesInvisibles");break;case"supprimerCompetence":$("#competence-"+t).remove();break;default:$.getJSON("api/competences.php",{type:typeAffichageCompetences}).always(function(e){$("#arbreGestionCompetences").empty(),$("#arbreGestionCompetences").append('<li id="listeCompetences"><a href="#">Liste des compétences</a>'),$("#listeCompetences").append(genererListeCompetences(0,0,e,"gestionCompetences")),majArbre("#arbreGestionCompetences"),$('[data-toggle="modal"]').tooltip()})}}})}var $buttonSelectionne=$("#buttonToutesCompetences"),typeAffichageCompetences="getToutesLesCompetences";$("#buttonToutesCompetences").click(function(){"use strict";majArbreGestionCompetences("#buttonToutesCompetences","getToutesLesCompetences")}),$("#buttonCompetencesVisibles").click(function(){"use strict";majArbreGestionCompetences("#buttonCompetencesVisibles","getCompetencesVisibles")}),$("#buttonCompetencesInvisibles").click(function(){"use strict";majArbreGestionCompetences("#buttonCompetencesInvisibles","getCompetencesInvisibles")});
function actualiserBranche(i){"use strict";i.prepend('<i class="tree-indicator glyphicon glyphicon-chevron-right"></i>'),i.addClass("tree-branch"),i.on("click",function(i){if(this==i.target){var e=$(this).children("i:first");e.toggleClass("glyphicon-chevron-down glyphicon-chevron-right"),$(this).children().children().toggle()}}),i.children().children().toggle(),i.children(".tree-indicator, button, a").click(function(e){i.click(),e.preventDefault()})}$.fn.extend({treeview:function(){return this.each(function(){var i=$(this);i.addClass("treeview-tree"),i.find("li").each(function(){$(this)}),i.find("li").has("ul").each(function(){actualiserBranche($(this))})})}});
function genererListGroupItem(e,t,i,a,n,o){"use strict";var l,p,r="";return"validationCompetenceParTuteur"===i||"invalidationCompetencesUtilisateurs"===i?(l=e.idUtilisateur,p=e.prenomUtilisateur+" "+e.nomUtilisateur):(l=e.idCompetence,p=e.nomCompetence),r='<div id="list-group-item-'+l+'" class="list-group-item cursor-pointer couleur-'+t+'-bg" data-toggle="modal" ',r+=o?'data-target="#genericModal" data-type="'+i+'" data-id-competence="'+e.idCompetence+'" data-nom-competence="'+e.nomCompetence:'data-target="#connexionModal"',"validationCompetenceParTuteur"===i&&(r+='" data-nom-utilisateur="'+p+'" data-id-utilisateur="'+l),r+='"><div class="media"><div class="media-body">'+p+'</div><div class="media-right media-middle">',r+="validationCompetenceParTuteur"===i||"invalidationCompetencesUtilisateurs"===i?' <span id="utilisateur-':' <span id="competence-',r+=l+'" data-toggle="modal" data-placement="top" data-original-title="'+a+'" class="glyphicon cursor-pointer '+n+'" aria-hidden="true"></span></div></div></div>'}function buttonSubmitValidation(e){"use strict";var t,i,a=e.data.idCompetence,n=(e.data.nomCompetence,e.data.type);"validationCompetenceParTuteur"===n||"invalidationCompetencesUtilisateurs"===n?(t=e.data.idUtilisateur,i=$("#list-group-item-"+t)):i=$("#list-group-item-"+a),$(".tooltip").remove(),"validationCompetenceParTuteur"!==n&&"invalidationCompetencesUtilisateurs"!==n||(i.toggleClass("couleur-valide-bg"),i.toggleClass("couleur-attente-bg"),i.find("span.glyphicon").first().toggleClass("glyphicon-remove"),i.find("span.glyphicon").first().toggleClass("glyphicon-hourglass")),"validerCompetence"===n?($.getJSON("api/competences.php",{type:"validation",idCompetence:a}),i.attr("data-type","invaliderCompetenceTemporaire"),i.toggleClass("couleur-attente-bg"),i.find("span.glyphicon").first().toggleClass("glyphicon-ok"),i.find("span.glyphicon").first().toggleClass("glyphicon-hourglass"),i.find("span.glyphicon-hourglass").first().attr("data-original-title","Compétence en attente de validation")):"invaliderCompetenceTemporaire"===n?($.getJSON("api/competences.php",{type:"invalidation",idCompetence:a}),i.attr("data-type","validerCompetence"),i.toggleClass("couleur-attente-bg"),i.find("span.glyphicon").first().toggleClass("glyphicon-ok"),i.find("span.glyphicon").first().toggleClass("glyphicon-hourglass"),i.find("span.glyphicon-ok").first().attr("data-original-title","Valider la compétence")):"invaliderCompetence"===n?($.getJSON("api/competences.php",{type:"invalidation",idCompetence:a}),i.attr("data-type","validerCompetence"),i.toggleClass("couleur-valide-bg"),i.find("span.glyphicon").first().toggleClass("glyphicon-ok"),i.find("span.glyphicon").first().toggleClass("glyphicon-remove"),i.find("span.glyphicon-ok").first().attr("data-original-title","Valider la compétence")):"validationCompetenceParTuteur"===n?($.getJSON("api/competences.php",{type:"validationCompetenceParTuteur",idCompetence:a,idUtilisateur:t}),i.attr("data-type","invalidationCompetencesUtilisateurs"),i.find("span.glyphicon-remove").first().attr("data-original-title","Invalider l'étudiant")):"invalidationCompetencesUtilisateurs"===n&&($.getJSON("api/competences.php",{type:"invalidationCompetencesUtilisateurs",idCompetence:a,idUtilisateur:t}),i.attr("data-type","validationCompetenceParTuteur"),i.find("span.glyphicon-hourglass").first().attr("data-original-title","Valider l'étudiant"))}function afficherCompetence(e){"use strict";var t,i=e.data.idCompetence,a=e.data.nomCompetence,n=e.data.type;null!==$lienPrecedent&&($lienPrecedent.toggleClass("couleur-text-selection"),$lienPrecedent.toggleClass("couleur-text-lien")),$lienPrecedent=$("#competence-"+i),$lienPrecedent.toggleClass("couleur-text-lien"),$lienPrecedent.toggleClass("couleur-text-selection"),$.getJSON("api/competences.php",{type:"estConnecte"},function(e){t=e.estConnecte}),"sousCompetences"===n?$.getJSON("api/competences.php",{type:"sousCompetences",idPere:i},function(e){$("#panel-body-competences").empty(),$("#panel-body-competences").append('<div class="list-group-item heading">'+a+'</div><div id="competences-a-valider" class="list-group"></div>');for(var i=0,n=e.length;n>i;++i){var o=e[i];"attente"===o.etat?$("#competences-a-valider").append(genererListGroupItem(o,"attente","invaliderCompetenceTemporaire","Compétence en attente de validation","glyphicon-hourglass",t)):"valide"===o.etat?$("#competences-a-valider").append(genererListGroupItem(o,"valide","invaliderCompetence","Invalider la compétence","glyphicon-remove",t)):$("#competences-a-valider").append(genererListGroupItem(o,"","validerCompetence","Valider la compétence","glyphicon-ok",t))}$('[data-toggle="modal"]').tooltip()}).fail(function(e,t,i){console.error("getJSON failed, status: "+t+", error: "+i)}):$.getJSON("api/competences.php",{type:"getUtilisateursCompetence",idCompetence:i},function(e){$("#panel-body-etudiants").empty(),$("#panel-body-etudiants").append('<div class="list-group-item heading">'+a+'</div><div id="utilisateurs-a-valider" class="list-group"></div>');for(var t=0,n=e.length;n>t;++t){var o=e[t],l={idCompetence:i,nomCompetence:a,idUtilisateur:o.idUtilisateur,prenomUtilisateur:o.prenom,nomUtilisateur:o.nom};$("#utilisateurs-a-valider").append(genererListGroupItem(l,"attente","validationCompetenceParTuteur","Valider l'étudiant","glyphicon-hourglass",!0))}$('[data-toggle="modal"]').tooltip()}).fail(function(e,t,i){console.error("getJSON failed, status: "+t+", error: "+i)})}var $lienPrecedent=null;
var competencesValidees;$(window).on("load",function(){"use strict";var e=location.search.split("action=")[1];e?"gestion-competences"===e?($("#arbreGestionCompetences").empty(),$("#arbreGestionCompetences").hide(),$.getJSON("api/competences.php",{type:"getToutesLesCompetences"}).always(function(e){if(""!==e.responseText){$("#arbreGestionCompetences").append('<li id="listeCompetences"><a href="#">Liste des compétences</a>'),$("#listeCompetences").append(genererListeCompetences(0,0,e,"gestionCompetences")),majArbre("#arbreGestionCompetences"),$('[data-toggle="modal"]').tooltip();for(var t=0,s=e.length;s>t;++t){var i=e[t];if(void 0!==i.visible&&!i.visible||i.feuille&&i.visible){var n;n=i.feuille&&i.visible?"setCompetencesInvisibles":"setCompetencesVisibles";var o={idCompetence:i.idCompetence,nomCompetence:i.nomCompetence,visibilite:n};$("#competence-"+i.idCompetence+"-button-visibilite").off(),$("#competence-"+i.idCompetence+"-button-visibilite").click(o,setCompetencesVisibiliteOnClick)}}}$("#loader-competences").hide(),$("#arbreGestionCompetences").show()})):"valider-competences-utilisateurs"===e&&($("#listeCompetences").empty(),$("#arbreValidationCompetences").hide(),$.getJSON("api/competences.php",{type:"getCompetencesValidation"}).always(function(e){$("#listeCompetences").append('<a href="#">Liste des compétences</a>'),$("#listeCompetences").append(genererListeCompetences(0,0,e,"afficherCompetences")),majArbre("#arbreValidationCompetences");for(var t=0,s=e.length;s>t;++t){var i=e[t];if(i.feuille){var n={idCompetence:i.idCompetence,nomCompetence:i.nomCompetence,type:"getUtilisateursCompetence"};$("#competence-"+i.idCompetence).find("a").first().click(n,afficherCompetence)}}$("#loader-competences").hide(),$("#arbreValidationCompetences").show()})):($("#listeCompetences").empty(),$("#arbreListeCompetences").hide(),$.getJSON("api/competences.php",{type:"getCompetencesVisiblesSansFeuilles"}).always(function(e){$("#listeCompetences").append('<a href="#">Liste des compétences</a>'),$("#listeCompetences").append(genererListeCompetences(0,0,e,"afficherCompetences")),majArbre("#arbreListeCompetences");for(var t=0,s=e.length;s>t;++t){var i=e[t],n={idCompetence:i.idCompetence,nomCompetence:i.nomCompetence,type:"sousCompetences"};$("#competence-"+i.idCompetence).find("a").first().click(n,afficherCompetence)}$("#loader-competences").hide(),$("#arbreListeCompetences").show()}),$("#listeCompetencesValidees").empty(),$("#arbreListeCompetencesValidees").hide(),$.getJSON("api/competences.php",{type:"getCompetencesValides"}).always(function(e){e?(competencesValidees=e,$("#arbreListeCompetencesValidees").append('<li id="listeCompetencesValidees"><a href="#">Liste des compétences validées</a>'),$("#listeCompetencesValidees").append(genererListeCompetences(0,0,e,"afficherCompetences"))):$("#panel-body-competences-validees").append("<p>Aucunes compétences validées</p>"),majArbre("#arbreListeCompetencesValidees"),$("#loader-competences-validees").hide(),$("#arbreListeCompetencesValidees").show()}))});